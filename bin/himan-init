#!/usr/bin/env node
var path = require('path'),
    fs = require('fs'),
    fse = require('fs-extra'),
    request = require('request'),
    chalk = require('chalk'),
    inquirer = require('inquirer'),
    downloadRepo = require('download-git-repo'),
    ora = require('ora')
;

var $version = 'will download repo~~';
try{
    $version = require('../.tmp/$config').version
}catch(err){
    console.log(err)
}
console.log(chalk.blue($version))
//

const $tmp = path.resolve(__dirname, '../.tmp')
      $dist = process.cwd()
;
request(
    {
        url: "https://github.com/HiShanFire/hi-gulp4-cli-deps/raw/master/resources/$config.js"
    },
    (err, res, body) => {
        if(getVersion(body) == $version) return cloneNodeModules();

        var spinner = ora("downloading node_modules...")
        spinner.start();
        downloadRepo('HiShanFire/hi-gulp-cli-deps', $tmp, {clone:false}, (err)=>{
            spinner.stop();
            if(err) return console.log(err)
            console.log();
            console.log(chalk.green('download success!'))
        })
        cloneNodeModules();
    }
)

function getVersion(data){
    return eval('(function(){'+
            'var v; v='+ data +';'+
            'return v.version'
            +'})()')
}

function cloneNodeModules(){
    fse.copy( $tmp, $dist,
        (data)=>{
            if(data == path.resolve($tmp, 'package.json')) return false;
            return true;
        },
        (err) => {
            if(err) return console.log(err);
            console.log(chalk.green('copy success!'))
    })
}
